{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Giving Dashboard</title>
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <link rel="stylesheet" href="{% static 'core/css/offering-types.css' %}">
</head>
<body>

<!-- Overlay for mobile sidebar -->
<div class="overlay" id="overlay"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div>
        <div class="logo">
            <img src="https://img.icons8.com/ios-filled/50/7c3aed/home.png"/>
            <div>
                <div class="logo-text">Giving Dashboard</div>
                <small style="color: gray;">Faithful Stewardship</small>
            </div>
        </div>
        <div class="nav-section">
          <div class="nav-title">NAVIGATION</div>
            <a href="/" class="nav-link"><i class="fa-solid fa-gauge"></i> Dashboard</a>
            <a href="/offering/" class="nav-link active"><i class="fa-regular fa-file-lines"></i> Financial Report</a>
        </div>
        <div class="nav-section">
            <div class="nav-title">SPIRITUAL ENCOURAGEMENT</div>
            <div class="verse-box">
                <strong>Today's Verse</strong><br>
                "Each of you should give what you have decided in your heart to give, not reluctantly or under compulsion, for God loves a cheerful giver." - 2 Cor 9:7
            </div>
        </div>
    </div>
    <div>
        <div class="profile">
            <div class="profile-icon">{{ user.username|slice:":1" }}</div>
            <div>
                <div class="name">{{ user.username }}</div>
                {% if user.is_superuser == True %}
                  <small style="color: gray;">Admin</small>
                {% else %}
                  <small style="color: gray;">Staff</small>
                {% endif %}
            </div>
        </div>
        <div class="signout">Sign Out</div>
    </div>
</div>

<!-- Main Content -->
<div class="main">
    <div class="header">

        <div class="nav-header">
          <i class="fas fa-bars hamburger" id="hamburger"></i>
          <div>Church Giving</div>
        </div>
    
        <div>
            <div class="header-title">Vineyard Of Comfort Giving Dashboard</div>
            <small style="color: gray;">"God loves a cheerful giver" - Track our faithful stewardship</small>
        </div>

        <div class="filter-buttons">
            <input type="date" id="datePicker" class="date-picker">
        </div>

    </div>

    <!-- Cards -->
    <div class="cards" id="cards-container"></div>

    <!-- Charts -->
    <div class="charts">
        <div class="chart-box">
            <strong>Giving Trends</strong>
            <canvas id="givingTrend"></canvas>
        </div>
        <div class="chart-box">
            <strong>Giving by Type</strong>
            <canvas id="givingType"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const hamburger = document.getElementById("hamburger");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    hamburger.addEventListener("click", () => {
      sidebar.classList.toggle("open");
      overlay.classList.toggle("active");
    });

    // Close sidebar if overlay is clicked
    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("active");
    });

    // Offering detail page URLs
    const offeringPages = {
        "Tithe": "/print_out/",
        "Prophetic Offering": "prophetic-offering-details.html",
        "Special Offering": "special-offering-details.html",
        "Security Offering": "security-offering-details.html",
        "Maintainance Offering": "maintainance-offering-details.html",
        "Gigbare Offering": "gigbare-offering-details.html",
        "Alabiye Offering": "alabiye-offering-details.html",
        "Breakthrough Encounter Offering": "breakthrough-encounter-details.html",
        "Artisan and Trader Offering": "artisan-trader-details.html",
        "Deliverance Hour Offering": "deliverance-hour-details.html",
        "Pregnant Women and Nursing Mother Offering": "pregnant-women-details.html",
        "Friday Vigil Offering": "friday-vigil-details.html"
    };

const offeringsData = {
      "{{ today|date:'Y-m-d' }}": [
        {% for g in weekly_giving_data %}
          { 
              title: "{{ g.title|safe }}", 
              amount: {{ g.amount }},
              change: {{ g.change }},
              {% comment %} color: "{{ g.color }}", {% endcomment %}
              color: "{{ g.color }}",
              icon: "{{ g.icon }}"
          },
        {% endfor %}
      ]
    };
    const cardsContainer = document.getElementById("cards-container");
    const datePicker = document.getElementById("datePicker");

    function renderCards(dateKey) {
        cardsContainer.innerHTML = "";
        if (!offeringsData[dateKey]) {
            cardsContainer.innerHTML = "<p>No data for this date.</p>";
            return;
        }
        offeringsData[dateKey].forEach(item => {
            const changeClass = item.change >= 0 ? "up" : "down";
            const changeSymbol = item.change >= 0 ? "▲" : "▼";
            
            // Create card element
            const cardElement = document.createElement("div");
            cardElement.className = `card ${item.color}`;
            cardElement.innerHTML = `
                <div class="card-icon"><i class="${item.icon}"></i></div>
                <div class="card-title">${item.title}</div>
                <strong class="amount">$${item.amount}</strong>
                <div class="card-change ${changeClass}">
                    ${changeSymbol} ${Math.abs(item.change)}% <small>vs last period</small>
                </div>
            `;
            
            // Add click event to navigate to offering details page
            cardElement.addEventListener("click", () => {
                navigateToOfferingDetails(item.title);
            });
            
            cardsContainer.appendChild(cardElement);
        });
    }

    function navigateToOfferingDetails(offeringType) {
        // Get the URL for the offering type
        const pageUrl = offeringPages[offeringType];
        
        if (pageUrl) {
            // Navigate to the offering details page
            window.location.href = pageUrl;
        } else {
            console.warn(`No page URL found for offering type: ${offeringType}`);
            // Optionally, you could show a message to the user
            alert(`Details page for ${offeringType} is not available at the moment.`);
        }
    }

    const trendCtx = document.getElementById('givingTrend').getContext('2d');
    const typeCtx = document.getElementById('givingType').getContext('2d');
    let trendChart = new Chart(trendCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Giving', data: [], borderColor: '#6366f1', backgroundColor: '#6366f1', fill: false, tension: 0.3 }] },
        options: { plugins: { legend: { display: false } } }
    });
    let typeChart = new Chart(typeCtx, {
        type: 'pie',
        data: { labels: [], datasets: [{ data: [], backgroundColor: ['#f97316', '#10b981', '#6366f1'] }] }
    });

    function updateCharts(dateKey) {
        if (!offeringsData[dateKey]) return;
        const amounts = offeringsData[dateKey].map(o => o.amount);
        trendChart.data.labels = offeringsData[dateKey].map(o => o.title);
        trendChart.data.datasets[0].data = amounts;
        trendChart.update();

        typeChart.data.labels = offeringsData[dateKey].map(o => o.title);
        typeChart.data.datasets[0].data = amounts;
        typeChart.update();
    }

    datePicker.addEventListener("change", () => {
        const selectedDate = datePicker.value;
        localStorage.setItem("lastDate", selectedDate);
        renderCards(selectedDate);
        updateCharts(selectedDate);
    });

    // Determine last pushed date (latest in offeringsData)
    const allDates = Object.keys(offeringsData).sort();
    const latestDate = allDates[allDates.length - 1];

    // Load saved date or latest date if first time
    
    
    
  document.addEventListener("DOMContentLoaded", function () {
    let today = new Date().toISOString().split("T")[0];
    document.getElementById("datePicker").value = today;
  });

</script>
</body>
</html>    